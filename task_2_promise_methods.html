<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  <h1>Переопределение методов Promise</h1> 

  <p style="color: red">Вывод тестов в консоль браузера</p>

 

  <script>

  function isIterable(obj) {
    if (obj == null) {
      return false;
    }
    return typeof obj[Symbol.iterator] === 'function';
  }


  Promise._any = function(promises){

    if (!isIterable(promises)) {

      throw new AggregateError([
        new Error(),
      ], 'Object is not iterable');

    } else {

      return new Promise((resolve, reject) => {

        let count = promises.length;

        promises.forEach(function(promise, i) {   
          
          promise.then((value) => {            
              resolve(value)
          }, (error) => {
            count--;
            if (count == 0) {
              throw new AggregateError([
                new Error(),
              ], 'All promises were rejected');
            }
            return;
          })

        });

      });

    }
  }


  Promise._allSettled = function(promises){

    if (!isIterable(promises)) {

      throw new AggregateError([
        new Error(),
      ], 'Object is not iterable');

    } else {

      return new Promise((resolve, reject) => {

        let count = promises.length;
        let result = [];

        promises.forEach(function(promise, i) {   

          promise.then((value) => {
            result[i] = {status: "fulfilled", value: value}
            count--;
          }, (error) => {
            result[i] = {status: "rejected", reason: error}
            count--;
          }).then(() => {
            if (count === 0) resolve(result);
          })
          
        });

      });

    }
  }


  Promise.prototype._finally = function (fn) {

    function returnFinallyPromise(cb) {
      return new Promise(resolve => fn()).then(cb)
    }

    this.then(
      result => {
        returnFinallyPromise(result)
      },
      error => {
        returnFinallyPromise(new Promise.reject(error))

      }
    )
  };



  function checkPromiseNewFunc(){
    // change to check ._any
    Promise._allSettled([

        new Promise(resolve => setTimeout(() => resolve(1), 2000)),

        new Promise(resolve => setTimeout(() => resolve(2), 1800)),

        new Promise(resolve => setTimeout(() => resolve(3), 1500)),

        new Promise((resolve, reject) => setTimeout(() => reject("Error msg"), 1300))
        
      ]).then(value => console.log(value))

  }

  checkPromiseNewFunc();


  function checkPromiseNewMethod(){

    return new Promise((resolve, reject) => {
      if (Math.random() > 0.5) {
        setTimeout(() => resolve('> 0.5'), 1000);
      } else {
        setTimeout(() => reject("Failed"), 1000);
      }
    }).then(
      value => console.log(value), 
      error => console.log(error)
    )
    ._finally(() => {      
      console.log('Finally completed');
    });

  }

  checkPromiseNewMethod();


    

  </script>
</body>
</html>